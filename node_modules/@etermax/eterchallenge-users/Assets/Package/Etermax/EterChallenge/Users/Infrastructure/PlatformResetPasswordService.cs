using System;
using Etermax.Json;
using Etermax.Web.Client;
using Package.Etermax.EterChallenge.Users.Domain;
using UniRx;

namespace Package.Etermax.EterChallenge.Users.Infrastructure
{
    public class PlatformResetPasswordService : IResetPasswordService
    {
        private const string ResetPasswordResource = "/games/:gameId/reset-password";
        private readonly string _apiUrl;
        private readonly string _gameId;
        private readonly IWebClient _webClient;

        public PlatformResetPasswordService(string apiUrl, string gameId, IWebClient webClient)
        {
            _apiUrl = apiUrl;
            _gameId = gameId;
            _webClient = webClient;
        }

        public IObservable<Unit> ResetPassword(string email)
        {
            return CreatePayloadFor(email)
                .SelectMany(payload => SendRequestWith(payload));
        }

        private IObservable<Unit> SendRequestWith(string payload)
        {
            return _webClient
                .Post(_apiUrl + ResetPasswordResource)
                .ReplacePathParam("gameId", _gameId)
                .PutHeaders("Content-Type", "application/json")
                .Send(payload)
                .AsUnitObservable();
        }

        private IObservable<string> CreatePayloadFor(string email)
        {
            return Observable.Start(() => JsonObject.Create().Add("email", email).ToString());
        }
    }
}